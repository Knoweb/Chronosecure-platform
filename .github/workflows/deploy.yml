# Deployment Workflow for DigitalOcean Droplet
name: Deploy to DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # 1. Copy project files to correct folder on Droplet via SSH (using rsync/scp)
    - name: Copy files to Droplet
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        source: "./chronosecure/"
        target: "/root/chronosecure-app"
        strip_components: 1

    # 2. Add the Service Account Key file to the remote server
    - name: Create Service Account Key on Remote Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          # Write the secret JSON content to the file expected by docker-compose
          TARGET_DIR="/root/chronosecure-app"
          if [ "${{ secrets.DO_USERNAME }}" != "root" ]; then
            TARGET_DIR="/home/${{ secrets.DO_USERNAME }}/chronosecure-app"
          fi
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' > $TARGET_DIR/serviceAccountKey.json
          chmod 600 $TARGET_DIR/serviceAccountKey.json

    # 3. Create .env file from secrets
    - name: Create .env file on Remote Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          TARGET_DIR="/root/chronosecure-app"
          if [ "${{ secrets.DO_USERNAME }}" != "root" ]; then
            TARGET_DIR="/home/${{ secrets.DO_USERNAME }}/chronosecure-app"
          fi
          cd $TARGET_DIR
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" > .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
          echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env

    # 4. Configure Swap (Crucial for 2GB Droplets!)
    - name: Configure Swap File
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          # Check if swap exists
          if ! swapon --show | grep -q '/swapfile'; then
            echo "Creating 2GB Swap File..."
            fallocate -l 2G /swapfile
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo '/swapfile none swap sw 0 0' | tee -a /etc/fstab
            echo "Swap created."
          else
            echo "Swap already exists."
          fi
          
          # Adjust swappiness
          sysctl vm.swappiness=10
          echo 'vm.swappiness=10' | tee -a /etc/sysctl.conf

    # 5. Install Docker & Docker Compose if missing
    - name: Install Docker & Docker Compose
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          if ! command -v docker &> /dev/null; then
            echo "Docker not found. Installing..."
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y ca-certificates curl gnupg lsb-release
            mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            systemctl enable --now docker
          else
             echo "Docker is already installed."
          fi

    # 5. Run Docker Compose
    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        command_timeout: 30m
        script: |
          TARGET_DIR="/root/chronosecure-app"
          if [ "${{ secrets.DO_USERNAME }}" != "root" ]; then
            TARGET_DIR="/home/${{ secrets.DO_USERNAME }}/chronosecure-app"
          fi
          cd $TARGET_DIR
          
          # Fix nested folder issue if scp copied directory inside directory
          if [ -d "chronosecure" ]; then
            echo "Found nested chronosecure folder, moving files up..."
            mv chronosecure/* .
            rm -rf chronosecure
          fi
          
          # Stop existing containers
          docker compose down || true
          # Rebuild and start in detached mode
          docker compose up -d --build
          # Clean up unused images
          docker image prune -f
